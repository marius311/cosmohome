#!/usr/bin/env python

""" 
Goes through the /results/camb_boinc2docker/YYYY-MM-DD folder for the
previous day and compresses all of the results into a single YYYY-MM-DD.dat.gz
file which is a gzip of Python pickle where everything is converted to floats
and only a specific set of l-values are kept. 

To reduce yesterday's results:

    ./camb_boinc2docker_reducer

or to reduce some specific folders:

    ./camb_boinc2docker_reducer folder1 folder2 ...

"""


import tarfile
import numpy as np
import sys
from glob import glob
import re
from ConfigParser import RawConfigParser
from StringIO import StringIO
import cPickle as pickle
import gzip
import os, os.path as osp
from datetime import date, timedelta



dtype=np.float32

lvals = np.array(
  [   2,    3,    4,    5,    6,    7,    8,    9,   10,   11,   12,
     13,   14,   15,   16,   17,   18,   19,   20,   21,   22,   23,
     24,   25,   26,   27,   28,   29,   30,   31,   32,   33,   34,
     35,   36,   37,   40,   42,   44,   46,   48,   50,   52,   54,
     56,   58,   60,   67,   74,   81,   89,   97,  114,  131,  148,
    165,  182,  199,  216,  233,  250,  267,  284,  301,  318,  335,
    352,  369,  386,  403,  420,  437,  454,  471,  488,  505,  522,
    539,  556,  573,  590,  607,  624,  641,  658,  675,  692,  709,
    726,  743,  760,  777,  794,  811,  828,  845,  862,  879,  896,
    913,  930,  947,  964,  981,  998, 1015, 1032, 1049, 1066, 1083,
   1100, 1117, 1134, 1151, 1168, 1185, 1202, 1219, 1236, 1253, 1270,
   1287, 1304, 1321, 1338, 1355, 1372, 1389, 1406, 1423, 1440, 1457,
   1474, 1491, 1508, 1525, 1542, 1559, 1576, 1593, 1610, 1627, 1644,
   1661, 1678, 1695, 1712, 1729, 1746, 1763, 1780, 1797, 1814, 1831,
   1848, 1865, 1882, 1899, 1916, 1933, 1950, 1967, 1984, 2001, 2018,
   2035, 2052, 2069, 2086, 2103, 2120, 2137, 2154, 2171, 2188, 2205,
   2222, 2239, 2256, 2273, 2290, 2307, 2324, 2341, 2358, 2375, 2392,
   2409, 2426, 2443, 2460, 2477, 2494, 2511, 2528, 2545, 2562, 2579,
   2596, 2613, 2630, 2647, 2664, 2681, 2698, 2715, 2732, 2749, 2766,
   2783, 2800, 2817, 2834, 2851, 2868, 2885, 2902, 2919, 2936, 2953,
   2970, 2987, 3004, 3021, 3038, 3055, 3072, 3089, 3106, 3123, 3140,
   3157, 3174, 3191, 3208, 3225, 3242, 3259, 3276, 3293, 3310, 3327,
   3344, 3361, 3378, 3395, 3412, 3429, 3446, 3463, 3480, 3497, 3514,
   3531, 3548, 3565, 3582, 3599, 3616, 3633, 3650, 3667, 3684, 3701,
   3718, 3735, 3752, 3769, 3786, 3803, 3820, 3837, 3854, 3871, 3888,
   3905, 3922, 3939, 3956, 3973, 3990, 4007, 4024, 4041, 4058, 4075,
   4092, 4109, 4126, 4143, 4160, 4177, 4194, 4211, 4228, 4245, 4262,
   4279, 4296, 4313, 4330, 4347, 4364, 4381, 4398, 4415, 4432, 4449,
   4466, 4483, 4500, 4517, 4534, 4551, 4568, 4585, 4602, 4619, 4636,
   4653, 4670, 4687, 4704, 4721, 4738, 4755, 4772, 4789, 4806, 4823,
   4840, 4857, 4874, 4891, 4908, 4925, 4942, 4959, 4976, 4993, 5126,
   5326, 5626])



def reduce(folder,delete=True):

    reduced = {}
    succesful = []

    print 'Reducing %s...'%folder

    for tname in glob(osp.join(folder,'*')):
        if '--debug' in sys.argv: print tname
        try:
            with tarfile.open(tname) as tfile:
                for name in tfile.getnames():
                    match = re.search('([0-9]+)_(.*).(dat|ini)',name)
                    if match:
                        i,k,t = match.groups()
                        r = reduced[(tname,i)] = reduced.get((tname,i),{})
                        f = tfile.extractfile(name)
                        r[k] = read_ini(f) if t=='ini' else np.loadtxt(f,dtype=dtype)[lvals-2]
            succesful.append(tname)
        except Exception as e: 
            print e

    output = folder.rstrip('/')+'.dat.gz'
    pickle.dump(reduced,gzip.open(output,'wb'),protocol=2)
    if delete:
        for f in succesful: os.remove(f)
        if len(glob(osp.join(folder,'*')))==0: os.rmdir(folder)

def read_ini(f):
    config = RawConfigParser()
    config.optionxform=str
    config.readfp(StringIO('[root]\n'+f.read()))
    def tryfloat(x):
        try: return dtype(x)
        except: return x
    return {k:tryfloat(v) for k,v in config.items('root')}

if __name__=='__main__':

    if len(sys.argv)>1:
        for folder in sys.argv[1:]: reduce(folder)
    else:
        reduce(osp.join('/results/camb_boinc2docker',(date.today()-timedelta(1)).isoformat()))
